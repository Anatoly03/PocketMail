# Builds the project, floods the database with fake emails,
# and starts the server for preview image, which will be uploaded
# as an artifact for use in release workflow and README.

name: Build and Preview

on:
  push:
    branches:
      - main

concurrency:
  group: build-and-preview-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            client/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Migrate and build the backend
      - name: Build API
        run: |
          cd api
          go run src/main.go migrate
          go build -o pocketmail-api src/main.go

      # Build the client
      - name: Install dependencies
        run: npm ci

      - name: Build the project
        run: VITE_ALLOW_AUTO_LOGIN=1 npm run build --workspace=client

      # Serve the api server in the background
      - name: Start API server
        run: |
          cd api
          SMTP_PORT=:1025 ./pocketmail-api serve > ../api-server.log 2> ../api-server.err &
          echo $! > ../api-server.pid
          cd ..

      # Create test user and generate auth token
      - name: Create test user and save token
        id: create_test_user
        run: |
          TOKEN=$(npx tsx other/createTestUser.ts)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      # Flood the database and start the server for preview
      - name: Flood the database with fake emails
        run: npm run flood --workspace=other -- --no-ask

      # Serve the client server in the background
      - name: Start client server
        run: |
          npx serve -s client/dist -l 3000 &
          echo $! > ../client-server.pid

      # Create a screenshot of the app
      - uses: karol-brejna-i/webpage-screenshot-action@v1
        with:
          url: http://localhost:3000/?token=${{ steps.create_test_user.outputs.token }}
          output: screenshot.png
          scriptBefore: |
            // Wait for the app to load and display emails (synchronous block for 5 seconds)
            const start = Date.now();
            while (Date.now() - start < 5000) {}

      # Upload the screenshot as an artifact
      - uses: actions/upload-artifact@v4
        with:
          name: simple-screenshot
          path: ${{ github.workspace }}/*.png

      # Stop the api server, even if job fails.
      # Compliance with GitHub ToS: No long-running processes after the job finishes.
      - name: Stop API server and print logs
        if: always()
        run: |
          if [ -f api-server.pid ]; then
            kill $(cat api-server.pid) || true
            echo "--- API server stdout (last 100 lines) ---"
            tail -n 100 api-server.log || true
            echo "--- API server stderr (last 100 lines) ---"
            tail -n 100 api-server.err || true
            rm api-server.log api-server.err api-server.pid
          fi

      # Stop the client server, even if job fails.
      # Compliance with GitHub ToS: No long-running processes after the job finishes.
      - name: Stop client server
        if: always()
        run: |
          if [ -f client-server.pid ]; then
            kill $(cat client-server.pid) || true
            rm client-server.pid
          fi
